<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Cook Greet</title>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" ></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" >


	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.5.4/bootstrap-slider.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/css/Jcrop.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/js/Jcrop.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/css/Jcrop.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/js/Jcrop.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/css/ion.rangeSlider.min.css" >
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/css/ion.rangeSlider.skinNice.min.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/js/ion.rangeSlider.min.js"></script>

	<link rel="stylesheet" type="text/css" href="./dist/css/cook.css" >



	
</head>
<body>

	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button id="collapse_button" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a id="site_name" class="navbar-brand" href="./">Cook</a>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="dropdown" id="file_operation" style="display: none;">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">File<span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a id="new_img"  href="#" >New</a></li>
							<li><a id="delete_img" href="#" >Delete Image</a></li>
							<li><a id="download_img" href="#">Save Image</a></li>
							
						</ul>
					</li>		

				</ul>



			</div><!-- /.navbar-collapse -->
		</div><!-- /.container-fluid -->
	</nav>

	<div class="container" id="content">

		<div id="file_div">
			<input id="inp" type="file" style="display: none;" />
		</div>

		<div id="drop_container" style="display: none;">
			<div id="upload_tip">

				<svg class="upload_icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43"><path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"></path></svg>
				<div id="tip_text">
					<label for="_inp" class="btn btn-default">
						Choose a file
					</label> 
					, or drag it here
				</div>
				
			</div>
		</div>		

		<div id="loader" class="is-quiet">
			<br>
			<div class="loader-spinner"></div>
			<span id="loader-text"></span>
		</div>

		<div id="work_panel">
			<div id="wrapper_tricks" class="wrapper_work">
				<div id="tricks_panel" class="btn-group"></div>
			</div>

			<div id="wrapper_trick_name" class="wrapper_work">
				<div id="trick_name" ></div>
			</div>

			<div id="wrapper_toolbox" class="wrapper_work">
				<div id="toolbox"></div>
			</div>

			<div id="wrapper_image" class="wrapper_work">
				<div id="img_container">
					<img id="img" class="_img-thumbnail ">
				</div>
			</div>

		</div>

	</div>




	
	<script type="text/javascript">
		


		function triggerDrop(){
			drop_container.ondragover = drop_container.ondragenter = function(evt) {
				evt.preventDefault();
			};

			drop_container.ondrop = function(evt) {		
				inp.files = evt.dataTransfer.files;
				evt.preventDefault();
			};

			file_operation.ondragover = file_operation.ondragenter = function(evt) {
				evt.preventDefault();
			};

			file_operation.ondrop = function(evt) {		
				inp.files = evt.dataTransfer.files;
				evt.preventDefault();
			};

			

			var dropTarget = $('#drop_container'),
			html = $('html');

			[ 'dragover', 'dragenter' ].forEach( function( event ){
				dropTarget.bind(event, function(){
					dropTarget.addClass('dragging');
				});
			});

			[ 'dragleave', 'dragend', 'drop' ].forEach( function( event )
			{
				dropTarget.bind(event, function(){
					dropTarget.removeClass('dragging');
				});
			});


		}

		function deleteImage(){
			var confirm_del=confirm('Confirm to delete imageï¼Ÿ');
			if (confirm_del == false) {
				return;
			}

			eraseCookie('origin_name');
			eraseCookie('uid');
			eraseCookie('step');
			eraseCookie('max_step');
			eraseCookie('src_ext');
			eraseCookie('undo');
			createCookie('is_online',0,1);	
			$('#work_panel').css('display','none');
			$('#file_operation').css('display','none');
			$('#drop_container').css('display','block');
		}

		function getDownloadName(){
			var origin_name = readCookie('origin_name');
			var array_origin_name = origin_name.split('.');
			var ext=array_origin_name[array_origin_name.length-1];	
			array_origin_name.pop(); // this line alt array_origin_name !
			var name=array_origin_name.join('');
			var download_name= name + '_cooked.' +ext;

			return download_name;
		}

		/* standing by */
		function confirmWhenCloseTab(){
			window.onbeforeunload = function (e) {
				e = e || window.event;

				if (e) {
					e.returnValue = 'Sure?';
				}

				return 'Sure?';
			};
		}

		function test(){}


	</script>



	
	
	
	
	<script type="text/javascript">
		var API_PATH = "../chef/api.php";
		var IMGS_PATH = "../imgs";

		init(); 
		test();
		


		function init(){
			if( readCookie('is_online') != '1'){ 
				$('#drop_container').css('display','block');
			}else{
				reloadImg();
				showTricks();
				$('#file_operation').css('display','block');
			}

			$('#new_img').click(function() {
				$('#collapse_button').click();
				$('#work_panel').css('display','none');
				$('#drop_container').css('display','block');
				triggerDrop(); // reload event after display_none 
				$('#inp').click();
			});

			$('#delete_img').click(function() {
				deleteImage();
			});

			triggerDrop();	
			$('#drop_container').click(function() {
				$('#inp').click();
			});

			document.getElementById("inp").addEventListener("change", readFile);

		}




		function readFile() {
			$('#work_panel').css('display','block');
			$('#drop_container').css('display','none');
			$(".btn").prop("disabled", true);

			var file_input = document.getElementById("inp")
			if (file_input.files && file_input.files[0]) {
				var FR= new FileReader();
				var content = '';
				FR.addEventListener("load", function(e) {
					document.getElementById("img").src       = e.target.result;

					showLoader('Loaded image, uploading ...');
					var image = {
						"origin_name": file_input.files[0].name,
						"content":e.target.result
					};
					deposit(image);
				});
				FR.readAsDataURL(file_input.files[0]);

				FR.onloadstart = function(e){
					$('#plate').html('<img id="img" >');
					showLoader('Loading image...');
				};
			}
		}


		function deposit(image) {
			var path = API_PATH + "/deposit"

			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				hideLoader();

				if (xhr.status == 201) {
					console.log(response);
					eraseCookie('origin_name');
					eraseCookie('uid');
					eraseCookie('step');
					eraseCookie('max_step');
					eraseCookie('src_ext');
					eraseCookie('undo');
					eraseCookie('is_online');

					createCookie('origin_name',image.origin_name,1);
					createCookie('uid',response.uid,1);
					createCookie('step',response.step,1);
					createCookie('max_step',response.step,1);
					createCookie('src_ext',response.src_ext,1);
					createCookie('undo',0);
					createCookie('is_online',1,1);
					

					
					showTricks();
					showFileOperation();
					$(".btn").prop("disabled", false);
					
				}else{
					console.log('deposit status not 201');
				}

			}).error( function(e) {
				console.log('deposit error:');
				console.log(e);
			});
		}


		function showTricks(){
			path = API_PATH + "/tricks"
			showLoader('Loading valid tricks from server ...');

			$.ajax({
				url: path,
				type: 'GET',
				dataType: "json",
			}).success( function(response,status,xhr) {
				if (xhr.status == 200) {
					showButtons(response);	
					hideLoader();			
				}else{
					console.log('showTricks() error occured')
				}
			}).error( function(e) {
				console.log('showTricks() error occured:');
				console.log(e);
			});
		}

		function getTricksTree(tricks,json_object){
			// make hash table
			var group_name,
			group,
			i,
			hash_table={},
			trick,
			map_table={},
			tricks_tree;

			tricks_tree=json_object.tricks_classify;
			for(group_name in tricks_tree){
				group = json_object.tricks_classify[group_name];
				for( i in group){ 
					hash_table[group[i]] = group_name;
				}
			}


			tricks_tree['others'] = [];
			for(i in tricks){
				trick = tricks[i];
				if (!hash_table.hasOwnProperty(trick)) {
					tricks_tree['others'].push(trick)
				}
			}

			return tricks_tree;
		}

		function showButtons(tricks){
			$.getJSON("tricks.json?"+ new Date().getTime(), function(json_object) {

				var tricks_tree = getTricksTree(tricks,json_object);

				var group_name,i,trick,trick_groups='';
				for( group_name in tricks_tree){


					trick_buttons ='';
					for( i in  tricks_tree[group_name]){
						trick = tricks_tree[group_name][i];
						trick_buttons +='<li class="trick_button" data-trick="'+trick+'"><a href="#">'+upFirstLetter(trick)+'</a></li>';
					}

					trick_groups+='<div class="btn-group" role="group"><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">'+upFirstLetter(group_name) +'<span class="caret"></span></button><ul class="dropdown-menu">'+trick_buttons+'</ul></div>';

				}

				html_edit = '<button id="undo" type="button" class="btn btn-default travel" >U</button><button id="redo" type="button" class="btn btn-default travel">R</button>';
				html_tricks_panel=html_edit+trick_groups;
				$('#tricks_panel').html(html_tricks_panel);
				checkStep();


				$('.trick_button').click(function() {
					wish($(this).data('trick'))
				});

				$('#undo').click(function() {
					$(".btn").prop("disabled", true);
					undo();					
				});

				$('#redo').click(function() {
					$(".btn").prop("disabled", true);
					redo();
				});


			});

		}

		// check after tricked, or traveled
		function checkStep(){
			step = readCookie('step');
			max_step = readCookie('max_step');
			
			if (step > 0) {
				$("#undo").prop("disabled", false);
			}
			else{
				$("#undo").prop("disabled", true);
			}

			if (max_step <= step ) {
				$("#redo").prop("disabled", true);
				createCookie('max_step',step,1);
			}
			else{
				$("#redo").prop("disabled", false);
			}

		}

		function undo(){
			step_now =  Number(readCookie('step'))
			createCookie('step',step_now-1,1);
			createCookie('undo',1,1);
			reloadImg();
		}

		function redo(){
			step_now =  Number(readCookie('step'))
			createCookie('step',step_now+1,1);
			reloadImg();
		}

		function reloadImg(){
			$(".btn").prop("disabled", true);
			showLoader('Reloading image...');


			step_after=readCookie('step');
			uid = readCookie('uid');
			src_ext = readCookie('src_ext');

			$('#img').on('load', function(){
				hideLoader();
				emptyToolbox();
				reloadPanel();
				
				$(".btn").not(".travel").prop("disabled", false);
				checkStep();

				$('#img').off('load'); // prevent Jcrop intialization trigger this.func
			});

			$("#img").removeAttr('width');
			$("#img").removeAttr('height');
			$("#img").removeClass('img_resizing');
			$("#img").removeAttr('style'); // remove Jcrop style
			
			
			var img_path=IMGS_PATH +'/' +uid +'/step' +step_after+'.'+src_ext ;
			// add ?time is unevitable, to prevent cache, though it slow load speed
			var img_fresh= img_path +'?time='+new Date().getTime();
			$('#img')[0].src = img_fresh;
			$('#download_img').prop('href',img_fresh);
			$('#download_img').prop('download',getDownloadName );
		}

		function showFileOperation(){
			$('#file_operation').css('display','block');
		}

		function emptyToolbox(){
			$('#toolbox').html('');
		}

		
		// wish to deposited image
		function wish(trick){
			// initial toolbox and reset img
			$('#toolbox').html('');

			// render toolbox & set img
			argv_3p = '';
			if (trick == 'resize') {
				focusTrick(trick);
				$("#img").addClass('img_resizing');

				html_toolbox='Width: <input id="resize_width" type="number"> Height: <input id="resize_height" type="number"> <label>Lock Aspect Ratio<input id="aspect_lock" type="checkbox" ></label>	<input type="text" id="resize_slider" name="example_name" value="" /><button id="resize_apply" class="btn btn-default">Apply</button><button id="resize_cancel" class="btn btn-default">Cancel</button>';
				$('#toolbox').html(html_toolbox);

				var img_size = {
					'display_width':$('#img')[0].width,
					'display_height':$('#img')[0].height,
					'natural_width':$('#img')[0].naturalWidth,
					'natural_height':$('#img')[0].naturalHeight,
				} ;
				$('#resize_width').val(img_size.natural_width);
				$('#resize_height').val(img_size.natural_height);

				var aspect_ratio = (img_size.natural_width/img_size.natural_height);

				$('#aspect_lock').change(function(){
					if ($(this).is(':checked')) {
						width_inputbox = $('#resize_width').val();;
						height_inputbox = $('#resize_height').val();;
						if ( height_inputbox * aspect_ratio != width_inputbox ) {
							$('#resize_height').val(width_inputbox * aspect_ratio)
						}

						$('#resize_width').on('input',function(e){
							now_width = this.value;
							$('#resize_height').val(Math.round(now_width * aspect_ratio));
						});

						$('#resize_height').on('input',function(e){
							now_height = this.value;
							$('#resize_width').val(Math.round(now_height * aspect_ratio));
						});

					}
					else{
						$('#resize_width').off('input');
						$('#resize_height').off('input');
					}
				});

				$("#resize_slider").ionRangeSlider({
					min: 1,
					max: 200,
					from: 100,
					postfix: "%",
					onChange: function (data) {
						$('#img').css({
							"max-width":"200%"
						});
						$( "#aspect_lock" ).prop( "checked", true );					
						resized_width = Math.round(img_size.natural_width * data.from * 0.01);
						resized_height = Math.round(img_size.natural_height * data.from * 0.01);
						$('#resize_width').val(resized_width);
						$('#resize_height').val(resized_height);
						$('#img')[0].width=Math.round( img_size.display_width * data.from * 0.01);
						$('#img')[0].height=Math.round(img_size.display_height * data.from * 0.01);

					},
				});


				$('#resize_apply').click(function() {
					argv_3p = $('#resize_width').val() +' '+ $('#resize_height').val();
					$('#toolbox').html('');
					$('#img').css({
						"max-width":""
					});	
					sendWish(trick,argv_3p);
				});

				$('#resize_cancel').click(function() {				
					$('#toolbox').html('');
					reloadImg();
				});

			}
			else if(trick == 'crop'){
				focusTrick(trick); 

				box_width = $("#img_container").width();
				box_height = $("#img_container").height();
				image_natural_width = $("#img")[0].naturalWidth;
				image_natural_height = $("#img")[0].naturalHeight;

				html_toolbox = 'Offset-x:<input id="crop_x" type="number" max="'+image_natural_width+'" min="0" disabled>Offset-y:<input id="crop_y" type="number" max="'+image_natural_width+'" min="0" disabled>Crop_width:<input id="crop_width" type="number" max="'+image_natural_width+'" min="0" disabled>Crop_height:<input id="crop_height" type="number" max="'+image_natural_width+'" min="0" disabled><br><button id="crop_apply" class="btn btn-default">Apply</button><button id="crop_cancel" class="btn btn-default">Cancel</button>';
				$('#toolbox').html(html_toolbox);


				$('#img').Jcrop({ 
					boxWidth: box_width,
					setSelect:   [  
					image_natural_width / 4 ,
					image_natural_height / 4,
					image_natural_width / 2,
					image_natural_height / 2 
					], 
					onChange: cropShowCoords,

				});

				

				

				$('#crop_apply').click(function() {
					argv_3p = $('#crop_x').val() +' '+ $('#crop_y').val()+' '+ $('#crop_width').val()+' '+ $('#crop_height').val();
					$('#toolbox').html('');
					$('#img').data('Jcrop').destroy();
					sendWish(trick,argv_3p);

				});

				$('#crop_cancel').click(function() {				
					$('#toolbox').html('');
					$('#img').data('Jcrop').destroy();
					reloadImg();
				});

				// double click to apply
				var jcrop_selection = $('.jcrop-selection');
				if (jcrop_selection.length != 0) {
					$('.jcrop-selection').dblclick(function(){
						$('#crop_apply').click();
					});
				}
			}
			else if (trick == 'flip'){
				focusTrick(trick);

				html_toolbox = '<button id="flip_x" class="flip_type btn btn-default" value="x">x</button><button id="flip_y" class="flip_type btn btn-default" value="y">y</button><button id="flip_z" class="flip_type btn btn-default" value="z">z</button><button id="flip_reset" value="0" class="btn btn-default">reset</button> <br><button id="flip_apply" class="btn btn-default">Apply</button><button id="flip_cancel" class="trick_cancel btn btn-default">Cancel</button><input id="flip_type_store" style="display:none;">';	
				$('#toolbox').html(html_toolbox);
				flipReset();



				$('.flip_type').click(function() {				
					flipImg(this.value);	
					$("#flip_reset").prop("disabled", false);
					$("#flip_apply").prop("disabled", false);	
					$('#flip_type_store').val(this.value);
					console.log($('#flip_type_store').val());
				});



				$('#flip_reset').click(function() {				
					flipReset();

				});


				$('#flip_apply').click(function() {				
					
					map={
						'x':0,
						'y':1,
						'z':2
					};
					argv_3p =map[$('#flip_type_store').val()];
					sendWish(trick,argv_3p);
				});

				addCancelListener();
			}
			else if (trick == 'binarization'){
				focusTrick(trick);
				$('#toolbox').html(makeSliderToolbox(trick));

				// argv3 must be odd
				$('#'+trick+'_slider').ionRangeSlider({
					min: 1,
					max: 255,
					step: 2 ,
					from: 128,
					postfix: "",
					onFinish: function (data) {
						sendPreview(trick,data.from);
					},
				});

				addFocusListener(trick);
			}
			else if (trick == 'gaussian_blur') {
				focusTrick(trick);
				$('#toolbox').html(makeSliderToolbox(trick));

				// argv3 must be odd
				$('#'+trick+'_slider').ionRangeSlider({
					min: 1,
					max: 21,
					step: 2 ,
					from: 9,
					postfix: "",
					onFinish: function (data) {
						sendPreview(trick,data.from);
					},
				});

				addFocusListener(trick);

			}
			else if (trick == 'median_blur') {
				focusTrick(trick);
				$('#toolbox').html(makeSliderToolbox(trick));

				// argv3 must be odd
				$('#'+trick+'_slider').ionRangeSlider({
					min: 1,
					max: 21,
					step: 2 ,
					from: 9,
					postfix: "",
					onFinish: function (data) {
						sendPreview(trick,data.from);
					},
				});

				addFocusListener(trick);

			}

			else if (trick == 'blur') {
				focusTrick(trick);
				$('#toolbox').html(makeSliderToolbox(trick));

				$('#'+trick+'_slider').ionRangeSlider({
					min: 1,
					max: 20,
					step: 1 ,
					from: 9,
					postfix: "",
					onFinish: function (data) {
						sendPreview(trick,data.from);
					},
				});

				addFocusListener(trick);

			}

			else if(trick == 'histogram'){
				focusTrick(trick);
				html_toolbox = '<button class="trick_cancel btn btn-default">Back</button>';
				$('#toolbox').html(html_toolbox);
				addCancelListener();
				sendPreview(trick,'');
			}

			else{
				sendWish(trick,argv_3p);
			}
		}

		function addFocusListener(trick){
			$('#'+trick+'_apply').click(function() {	
				var argv_3p = $('#'+trick+'_slider').data('ionRangeSlider').result.from;			
				sendWish(trick,argv_3p);
			});

			addCancelListener();
			sendPreview(trick,$('#'+trick+'_slider').data('ionRangeSlider').result.from);
		}

		function makeSliderToolbox(trick){
			html_toolbox='<input type="text" id="'+trick+'_slider" name="example_name" value="" /><button id="'+trick+'_apply" class="btn btn-default">Apply</button> <button id="'+trick+'_cancel" class="btn btn-default trick_cancel">Cancel</button>';
			return html_toolbox;
		}

		function flipReset(){
			flipImg(0);	
			$("#flip_reset").prop("disabled", true);
			$("#flip_apply").prop("disabled", true);	
		}

		function flipImg(type) {
			var j = document.getElementById("img");
			j.style.transitionDuration = "0.5s"

			if (type == 'x') {

				j.style.transform = "rotateX(180deg)";
				
			}else if (type == 'y') {

				j.style.transform = "rotateY(180deg)";

			}else if (type == 'z') {
				
				j.style.transform = "rotateZ(180deg)";

			} else if (type == '0') {
				
				j.style.transform = "";

			} 

			else {
				console.log('flipImg has wrong type');
				return ;
			}

		}

		function addCancelListener(){
			$('.trick_cancel').click(function() {				
				$('#toolbox').html('');

				if ($('#img').data('Jcrop')) {
					$('#img').data('Jcrop').destroy();
				}
				
				reloadImg();
			});
		}


		function cropShowCoords(c){
			$('#crop_x').val(Math.round(c.x));
			$('#crop_y').val(Math.round(c.y));
			$('#crop_width').val(Math.round(c.w));
			$('#crop_height').val(Math.round(c.h));
		}

		function sendPreview(trick,argv_3p) {	
			$(".btn").prop("disabled", true); 
			showLoader('Processing...');

			var path = API_PATH + "/tricks/" + trick;

			image = {
				"is_preview":1,
				"uid" : readCookie('uid'),
				"step" : readCookie('step'),
				"src_ext" : readCookie('src_ext'),
				"origin_name" : readCookie('origin_name'),
				"argv_3p" : argv_3p
			}


			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status == 201) {
					onPreview(response); 				
				}else{
					var message = 'wish() status code wrong!';
					showLoader(message);
					console.log(message);
				}
			}).error( function(e) {
				console.log('wish() eroor occured');
				console.log(e);
			});
		}




		// apply
		function sendWish(trick,argv_3p) {	
			$(".btn").prop("disabled", true); 
			showLoader('Processing...');

			var path = API_PATH + "/tricks/" + trick;

			image = {
				"uid" : readCookie('uid'),
				"step" : readCookie('step'),
				"src_ext" : readCookie('src_ext'),
				"origin_name" : readCookie('origin_name'),
				"argv_3p" : argv_3p
			}


			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status == 201) {
					onPlate(response); 				
				}else{
					var message = 'wish() status code wrong!';
					showLoader(message);
					console.log(message);
				}
			}).error( function(e) {
				console.log('wish() eroor occured');
				console.log(e);
			});
		}

		function onPreview(response){
			showLoader('Downloading processed image...');

			$(".btn").prop("disabled", true);
			showLoader('Reloading image...');

			step_after='_preview';
			uid = response.image.uid;
			src_ext = readCookie('src_ext');

			$('#img').on('load', function(){
				hideLoader();
				
				$(".btn").not(".travel").prop("disabled", false);
				checkStep();

				$('#img').off('load'); // prevent Jcrop intialization trigger this.func
			});

			$("#img").removeAttr('width');
			$("#img").removeAttr('height');
			$("#img").removeClass('img_resizing');
			$("#img").removeAttr('style'); // remove Jcrop style
			
			
			var img_path=IMGS_PATH +'/' +uid +'/step' +step_after+'.'+src_ext ;
			// add ?time is unevitable, to prevent cache, though it slow load speed
			var img_fresh= img_path +'?time='+new Date().getTime();
			$('#img')[0].src = img_fresh;
			
		}





		// order, with image and trick
		function order(image,trick) {
			console.log(image,trick)

			var path = API_PATH + "/tricks/" + trick

			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status = 201) {
					console.log('order() ok');
					console.log('response');
				}else{
					alert('order() status not 201');
				}
			}).error( function(e) {
				console.log('order() error occured!');
				console.log(e);
			});
		}

		function onPlate(response){
			
			uid=response.image.uid;
			step = response.image.step;
			src_ext = response.image.dst_ext;

			createCookie('step',step,1);
			createCookie('src_ext',src_ext,1);

			is_undo = Number(readCookie('undo'));
			if (is_undo == 1) { // if undo, reset max_step
				createCookie('max_step',step,1);
				createCookie('undo',0,1);
			}

			showLoader('Downloading processed image...');
			reloadImg();
		}

		function focusTrick(trick){
			$('#tricks_panel').hide();

			$('#trick_name').html(upFirstLetter(trick) );
			$('#trick_name').show();
		}

		function reloadPanel(){
			$('#tricks_panel').show();

			$('#trick_name').hide();
			$('#trick_name').html('');
		}

		function getFile(){
			var files = document.getElementById("inp").files;
			if (files.length > 1){
				return 'please upload one file only!';
			} 
			return files[0];
		}

		function showLoader($text){
			$('#loader-text').html($text);
			$('#loader').removeClass('is-quiet');
			$('#loader').addClass('is-active');
		}

		function hideLoader(){
			$('#loader').removeClass('is-active');
			$('#loader').addClass('is-quiet');
		}


		// cookie
		function createCookie(name,value,days) {
			if (days) {
				var date = new Date();
				date.setTime(date.getTime()+(days*24*60*60*1000));
				var expires = "; expires="+date.toGMTString();
			}
			else var expires = "";
			document.cookie = name+"="+value+expires+"; path=/";
		}

		function readCookie(name) {
			var nameEQ = name + "=";
			var ca = document.cookie.split(';');
			for(var i=0;i < ca.length;i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1,c.length);
				if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
			}
			return null;
		}

		function eraseCookie(name) {
			createCookie(name,"",-1);
		}


		// capitalizeFirstLetter
		function upFirstLetter(string) {
			return string.charAt(0).toUpperCase() + string.slice(1);
		}

	</script>
</body>
</html>