<!DOCTYPE html>
<html>
<head>
	<title>Cook Greet</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="./dist/css/cook.css" >

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" ></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" >
	

	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.5.4/bootstrap-slider.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/css/Jcrop.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/js/Jcrop.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/css/Jcrop.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/js/Jcrop.min.js"></script>

	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/css/ion.rangeSlider.min.css" >
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/css/ion.rangeSlider.skinNice.min.css" >
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.1.7/js/ion.rangeSlider.min.js"></script>


	
</head>
<body>

	<div id="loader" class="is-quiet">
		<br>
		<div class="loader-spinner"></div>
		<span id="loader-text"></span>
	</div>

	<div id="wrapper_newfile">
		<input id="inp" type='file'>
	</div><br>

	<div id="wrapper_tricks">
		<div id="tricks"></div>
	</div><br>

	<div id="wrapper_image">
		<img id="img" height="250">
	</div><br>
	
	


	<button id="test">test</button>

	<input type="text" id="example_id" name="example_name" value="" />

	<div class="btn-group" role="group" aria-label="...">
		<button type="button" class="btn btn-default">U</button>
		<button type="button" class="btn btn-default">R</button>

		<div class="btn-group" role="group">
			<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				Basic
				<span class="caret"></span>
			</button>
			<ul class="dropdown-menu">
				<li><a href="#">resize</a></li>
				<li><a href="#">Dropdown link</a></li>
			</ul>
		</div>

		<div class="btn-group" role="group">
			<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				Effect
				<span class="caret"></span>
			</button>
			<ul class="dropdown-menu">
				<li><a href="#">Dropdown link</a></li>
				<li><a href="#">Dropdown link</a></li>
			</ul>
		</div>

	</div>
	



	
	
	
	
	<script type="text/javascript">

		var API_PATH = "../chef/api.php";
		var PLATE_PATH = "../plate";
		var FRIDGE_PATH = "../fridge";

		// load image from cookie, if cookie has set
		if( readCookie('unique_name') != null){
			showImageReady(readCookie('unique_name'));
			showTricks();
		}

		//$('#img').Jcrop({ boxWidth: 200, boxHeight: 200 });
		$("#example_id").ionRangeSlider({
			min: 1,
			max: 200,
			from: 100,
			postfix: "%"
		});


			


		document.getElementById("inp").addEventListener("change", readFile);

		function readFile() {		
			var file_input = document.getElementById("inp")
			if (file_input.files && file_input.files[0]) {
				var FR= new FileReader();
				var content = '';
				FR.addEventListener("load", function(e) {
					document.getElementById("img").src       = e.target.result;
	
					showLoader('Loaded image, uploading ...');
					var image = {
						"origin_name": file_input.files[0].name,
						"content":e.target.result
					};
					deposit(image);
				});
				FR.readAsDataURL(file_input.files[0]);

				FR.onloadstart = function(e){
					$('#plate').html('<img id="img" height="150">');
					showLoader('Loading image...');
				};
			}
		}


		function deposit(image) {
			var path = API_PATH + "/deposit"

			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				hideLoader();

				if (xhr.status == 201) {
					eraseCookie('origin_name');
					eraseCookie('unique_name');

					createCookie('origin_name',image.origin_name,1);
					createCookie('unique_name',response.unique_name,1);

					
					showTricks();
					
				}else{
					console.log('deposit status not 201');
				}

			}).error( function(e) {
				console.log('deposit error:');
				console.log(e);
			});
		}


		function showTricks(){
			path = API_PATH + "/tricks"
			showLoader('Loading valid tricks from server ...');

			$.ajax({
				url: path,
				type: 'GET',
				dataType: "json",
			}).success( function(response,status,xhr) {
				if (xhr.status == 200) {
					showButtons(response);	
					hideLoader();			
				}else{
					console.log('showTricks() error occured')
				}
			}).error( function(e) {
				console.log('showTricks() error occured:');
				console.log(e);
			});
		}

		function showButtons(tricks){
			buttons = 'tricks: ';

			$.getJSON("tricks.json?"+ new Date().getTime(), function(data) {
			console.log(data); 

			// make hash table
			var group_name,
			group,
			i,
			hash_table={};

			for(group_name in data.tricks_classify){
				group = data.tricks_classify[group_name];
				for( i in group){
					console.log(group[i]); 
					console.log(group_name); 
					hash_table[group[i]] = group_name;
				}
			}

			console.log(hash_table); 

			// for (var i = data['tricks_reclassify'].length - 1; i >= 0; i--) {
			// 	console.log(data[i]); 
			// }

			

			// filter_object=data.filter[op];

			// if (filter_object.hasOwnProperty("argv_type")) {
			// 	if (filter_object.argv_type == 'slide') {
			// 		var argv_split=filter_object.argv_range.split(' ');
			// 		show_argv_control(op,argv_split,filter_object.argv_name)
			// 	}else if(filter_object.argv_type == 'resize'){
			// 		show_argv_control_resize(op,filter_object)
			// 	}else if(filter_object.argv_type == 'button'){
			// 		show_argv_control_button(op,filter_object)
			// 	}
			// }else{
			// 	$('#argv_control').html(capitalizeFirstLetter(op) + ' result:');
			// 	send_ajax(op);
			// }



		});




			for (var i = 0, len = tricks.length; i < len; i++) {
				buttons += '<button  class="trick_button">'+ tricks[i] +'</button> ';
			}

			$('#tricks').html(buttons);
			$('.trick_button').on('click',function() {
				$(".trick_button").prop("disabled", true);
				wish(this.textContent)
			});
		}




		// wish to deposited image
		function wish(trick) {		
			showLoader('Processing...');
			var path = API_PATH + "/tricks/" + trick


			image = {
					"unique_name" : readCookie('unique_name'),
					"origin_name" : readCookie('origin_name')
			}



			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status == 201) {
					onPlate(response.image.tricked_name); 				
				}else{
					console.log('wish() status code wrong!');
				}
			}).error( function(e) {
				console.log('wish() eroor occured');
				console.log(e);
			});
		}


		// apply button
		function sendWish(path,image){
			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status == 201) {
					onPlate(response.image.tricked_name); 				
				}else{
					console.log('wish() status code wrong!');
				}
			}).error( function(e) {
				console.log('wish() eroor occured');
				console.log(e);
			});
		}




		// order, with image and trick
		function order(image,trick) {
			console.log(image,trick)

			var path = API_PATH + "/tricks/" + trick

			$.ajax({
				url: path,
				type: 'PUT',
				dataType: "json",
				data: JSON.stringify(image),
			}).success( function(response,status,xhr) {
				if (xhr.status = 201) {
					console.log('order() ok');
					console.log('response');
				}else{
					alert('order() status not 201');
				}
			}).error( function(e) {
				console.log('order() error occured!');
				console.log(e);
			});
		}

		function onPlate($name_tricked){
			showLoader('Downloading processed image...');

			path_tricked= PLATE_PATH +'/' +$name_tricked +'?time='+ new Date().getTime() 
			
			$('#img').on('load', function(){
				hideLoader();
				$(".trick_button").prop("disabled", false);
			});

			var img = document.getElementById('img')
			img.src = path_tricked

		}

		function showImageReady($image_name){
			showLoader('Downloading image ...');

			path_tricked= FRIDGE_PATH +'/' +$image_name +'?time='+ new Date().getTime() 
			
			$('#img').on('load', function(){
				hideLoader();
			});

			var image = document.getElementById('img')
			image.src = path_tricked
		}




		function getFile(){
			var files = document.getElementById("inp").files;
			if (files.length > 1){
				return 'please upload one file only!';
			} 
			return files[0];
		}


		function showLoader($text){
			$('#loader-text').html($text);
			$('#loader').removeClass('is-quiet');
			$('#loader').addClass('is-active');
		}
		function hideLoader(){
			$('#loader').removeClass('is-active');
			$('#loader').addClass('is-quiet');
		}


		function createCookie(name,value,days) {
			if (days) {
				var date = new Date();
				date.setTime(date.getTime()+(days*24*60*60*1000));
				var expires = "; expires="+date.toGMTString();
			}
			else var expires = "";
			document.cookie = name+"="+value+expires+"; path=/";
		}

		function readCookie(name) {
			var nameEQ = name + "=";
			var ca = document.cookie.split(';');
			for(var i=0;i < ca.length;i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1,c.length);
				if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
			}
			return null;
		}

		function eraseCookie(name) {
			createCookie(name,"",-1);
		}

	</script>
</body>
</html>